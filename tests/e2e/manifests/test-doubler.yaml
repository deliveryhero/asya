apiVersion: asya.dev/v1alpha1
kind: AsyncActor
metadata:
  name: test-doubler
  namespace: asya
spec:
  queue: test-doubler-queue
  image: python:3.13-slim
  imagePullPolicy: IfNotPresent
  replicas: 1
  command: ["python", "/opt/asya/asya_runtime.py"]

  env:
    - name: ASYA_HANDLER
      value: "gateway_handlers.pipeline_doubler"
    - name: ASYA_SOCKET_PATH
      value: "/tmp/sockets/app.sock"
    - name: ASYA_SOCKET_CHMOD
      value: "666"
    - name: ASYA_INCLUDE_ROUTE_INFO
      value: "true"
    - name: ASYA_GATEWAY_URL
      value: "http://asya-gateway.asya.svc.cluster.local:8080"

  configMapVolumes:
    - name: handlers
      mountPath: /app/handlers.py
      subPath: handlers.py
      configMapName: test-handlers
    - name: runtime
      mountPath: /opt/asya/asya_runtime.py
      subPath: asya_runtime.py
      configMapName: test-handlers

  sidecar:
    image: asya-sidecar:latest
    imagePullPolicy: IfNotPresent
    env:
      - name: ASYA_RABBITMQ_URL
        value: "amqp://guest:guest@asya-rabbitmq.asya.svc.cluster.local:5672/"
      - name: ASYA_RABBITMQ_EXCHANGE
        value: "asya"
      - name: ASYA_QUEUE_NAME
        value: "test-doubler-queue"
      - name: ASYA_SOCKET_PATH
        value: "/tmp/sockets/app.sock"
      - name: ASYA_RUNTIME_TIMEOUT
        value: "30s"
      - name: ASYA_STEP_HAPPY_END
        value: "happy-end"
      - name: ASYA_STEP_ERROR_END
        value: "error-end"

  keda:
    enabled: true
    minReplicas: 1
    maxReplicas: 3
    pollingInterval: 10
    cooldownPeriod: 30
    triggers:
      - type: rabbitmq
        metadata:
          queueName: test-doubler-queue
          mode: QueueLength
          value: "5"
