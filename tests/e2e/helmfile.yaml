repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: prometheus-community
    url: https://prometheus-community.github.io/helm-charts
  - name: grafana
    url: https://grafana.github.io/helm-charts
  - name: kedacore
    url: https://kedacore.github.io/charts

releases:
  # Message Queue - RabbitMQ (using official image due to bitnami pull issues)
  - name: asya-rabbitmq
    namespace: asya
    chart: bitnami/rabbitmq
    version: 16.x.x
    values:
      - image:
          registry: docker.io
          repository: rabbitmq
          tag: 3.3-management-alpine
        auth:
          username: guest
          password: guest
          erlangCookie: asya-secret-cookie
        service:
          type: ClusterIP
        metrics:
          enabled: true
          serviceMonitor:
            enabled: false
        persistence:
          enabled: false
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

  # Metrics Collection - Prometheus
  - name: prometheus
    namespace: monitoring
    chart: prometheus-community/prometheus
    version: 25.x.x
    values:
      - server:
          persistentVolume:
            enabled: false
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          retention: "2h"
          service:
            type: NodePort
            nodePort: 30090
        alertmanager:
          enabled: false
        pushgateway:
          enabled: false
        nodeExporter:
          enabled: false
        kubeStateMetrics:
          enabled: true
        serverFiles:
          prometheus.yml:
            scrape_configs:
              - job_name: 'asya-actors'
                kubernetes_sd_configs:
                  - role: pod
                    namespaces:
                      names:
                        - asya
                relabel_configs:
                  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                    action: keep
                    regex: true
                  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                    action: replace
                    target_label: __address__
                    regex: ([^:]+):\d+;(\d+)
                    replacement: $1:$2
                  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                    action: replace
                    target_label: __metrics_path__
                    regex: (.+)
                  - source_labels: [__meta_kubernetes_namespace]
                    action: replace
                    target_label: kubernetes_namespace
                  - source_labels: [__meta_kubernetes_pod_name]
                    action: replace
                    target_label: kubernetes_pod_name

  # Visualization - Grafana
  - name: grafana
    namespace: monitoring
    chart: grafana/grafana
    version: 8.x.x
    values:
      - adminPassword: admin
        persistence:
          enabled: false
        datasources:
          datasources.yaml:
            apiVersion: 1
            datasources:
              - name: Prometheus
                type: prometheus
                url: http://prometheus-server.monitoring.svc.cluster.local
                access: proxy
                isDefault: true
        service:
          type: NodePort
          nodePort: 30000
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi

  # Event-driven Autoscaling - KEDA (v2.18.0)
  - name: keda
    namespace: keda
    chart: kedacore/keda
    version: 2.x.x
    values:
      - resources:
          operator:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
          metricsServer:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
        prometheus:
          metricServer:
            enabled: true
          operator:
            enabled: true

  # Asya Operator
  - name: asya-operator
    namespace: asya-system
    chart: ../../deploy/helm-charts/asya-operator
    values:
      - image:
          repository: asya-operator
          tag: latest
          pullPolicy: IfNotPresent
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 128Mi

  # Asya Gateway (with PostgreSQL)
  - name: asya-gateway
    namespace: asya
    chart: ../../deploy/helm-charts/asya-gateway
    values:
      - image:
          repository: asya-gateway
          tag: latest
          pullPolicy: IfNotPresent
        service:
          type: NodePort
          nodePort: 30080
        config:
          port: "8080"
          rabbitmqURL: amqp://guest:guest@asya-rabbitmq.asya.svc.cluster.local:5672
          rabbitmqExchange: asya
        env:
          - name: ASYA_CONFIG_PATH
            value: "/etc/asya/routes.yaml"
        postgresql:
          enabled: true
          auth:
            database: asya_gateway
            username: asya
            password: asya-db-password
          primary:
            persistence:
              enabled: false
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
              limits:
                cpu: 200m
                memory: 256Mi
        migration:
          enabled: true
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        volumes:
          - name: routes-config
            configMap:
              name: gateway-routes
        volumeMounts:
          - name: routes-config
            mountPath: /etc/asya
            readOnly: true

helmDefaults:
  wait: true
  timeout: 900
  createNamespace: true
  atomic: false
