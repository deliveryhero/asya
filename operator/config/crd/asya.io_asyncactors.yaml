apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: asyncactors.asya.io
  annotations:
    controller-gen.kubebuilder.io/version: v0.14.0
spec:
  group: asya.io
  names:
    kind: AsyncActor
    listKind: AsyncActorList
    plural: asyncactors
    singular: asyncactor
    shortNames:
    - asyncactor
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        description: AsyncActor is the Schema for the asyncactors API
        type: object
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation of an object.'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this object represents.'
            type: string
          metadata:
            type: object
          spec:
            description: AsyncActorSpec defines the desired state of AsyncActor
            type: object
            required:
            - queueName
            - workload
            properties:
              queueName:
                description: QueueName is the name of the queue this actor consumes from
                type: string
                minLength: 1

              transport:
                description: Transport configuration for message queue
                type: object
                required:
                - type
                properties:
                  type:
                    description: Type of transport (sqs or rabbitmq)
                    type: string
                    enum:
                    - sqs
                    - rabbitmq

                  sqs:
                    description: SQS-specific configuration
                    type: object
                    properties:
                      region:
                        type: string
                        default: us-east-1
                      queueBaseUrl:
                        type: string
                      visibilityTimeout:
                        type: integer
                        default: 300
                      waitTimeSeconds:
                        type: integer
                        default: 20

                  rabbitmq:
                    description: RabbitMQ-specific configuration
                    type: object
                    properties:
                      host:
                        type: string
                      port:
                        type: integer
                        default: 5672
                      username:
                        type: string
                      passwordSecretRef:
                        description: Reference to secret containing password
                        type: object
                        required:
                        - name
                        - key
                        properties:
                          name:
                            type: string
                          key:
                            type: string

              sidecar:
                description: Sidecar container configuration
                type: object
                properties:
                  image:
                    description: Sidecar image (defaults to asya-sidecar:latest)
                    type: string
                    default: asya-sidecar:latest
                  imagePullPolicy:
                    type: string
                    default: IfNotPresent
                    enum:
                    - Always
                    - IfNotPresent
                    - Never
                  resources:
                    description: Resource requirements for sidecar
                    type: object
                    properties:
                      limits:
                        type: object
                        additionalProperties:
                          type: string
                          x-kubernetes-int-or-string: true
                      requests:
                        type: object
                        additionalProperties:
                          type: string
                          x-kubernetes-int-or-string: true
                  env:
                    description: Additional environment variables
                    type: array
                    items:
                      type: object
                      x-kubernetes-preserve-unknown-fields: true

              socket:
                description: Unix socket configuration
                type: object
                properties:
                  path:
                    type: string
                    default: /tmp/sockets/app.sock
                  maxSize:
                    description: Maximum message size in bytes
                    type: string
                    default: "10485760"

              timeout:
                description: Timeout configuration
                type: object
                properties:
                  processing:
                    description: Processing timeout in seconds
                    type: integer
                    default: 300
                  gracefulShutdown:
                    description: Graceful shutdown timeout in seconds
                    type: integer
                    default: 30

              scaling:
                description: KEDA autoscaling configuration
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  minReplicas:
                    type: integer
                    default: 0
                    minimum: 0
                  maxReplicas:
                    type: integer
                    default: 50
                    minimum: 1
                  pollingInterval:
                    type: integer
                    default: 10
                  cooldownPeriod:
                    type: integer
                    default: 60
                  queueLength:
                    description: Number of messages per replica
                    type: integer
                    default: 5
                    minimum: 1

              workload:
                description: Workload template for the asya runtime
                type: object
                required:
                - type
                - template
                properties:
                  type:
                    description: Type of workload (Deployment, StatefulSet, Job)
                    type: string
                    enum:
                    - Deployment
                    - StatefulSet
                    - Job
                    default: Deployment

                  replicas:
                    description: Number of replicas (ignored if KEDA scaling is enabled)
                    type: integer
                    default: 1
                    minimum: 0

                  template:
                    description: Pod template spec for the runtime container
                    type: object
                    x-kubernetes-preserve-unknown-fields: true
                    properties:
                      metadata:
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      spec:
                        type: object
                        x-kubernetes-preserve-unknown-fields: true

          status:
            description: AsyncActorStatus defines the observed state of AsyncActor
            type: object
            properties:
              conditions:
                description: Conditions represent the latest available observations of the AsyncActor's state
                type: array
                items:
                  type: object
                  required:
                  - type
                  - status
                  properties:
                    type:
                      description: Type of condition
                      type: string
                    status:
                      description: Status of the condition (True, False, Unknown)
                      type: string
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                    lastTransitionTime:
                      description: Last time the condition transitioned
                      type: string
                      format: date-time
                    reason:
                      description: Reason for the condition's last transition
                      type: string
                    message:
                      description: Human-readable message
                      type: string

              workloadRef:
                description: Reference to the created workload
                type: object
                properties:
                  apiVersion:
                    type: string
                  kind:
                    type: string
                  name:
                    type: string
                  namespace:
                    type: string

              scaledObjectRef:
                description: Reference to the created KEDA ScaledObject
                type: object
                properties:
                  name:
                    type: string
                  namespace:
                    type: string

              observedGeneration:
                description: ObservedGeneration reflects the generation of the most recently observed AsyncActor
                type: integer
                format: int64

    subresources:
      status: {}

    additionalPrinterColumns:
    - name: Queue
      type: string
      jsonPath: .spec.queueName
    - name: Transport
      type: string
      jsonPath: .spec.transport.type
    - name: Workload
      type: string
      jsonPath: .spec.workload.type
    - name: Min
      type: integer
      jsonPath: .spec.scaling.minReplicas
    - name: Max
      type: integer
      jsonPath: .spec.scaling.maxReplicas
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
